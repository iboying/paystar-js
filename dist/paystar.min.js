/**
 * paystar-js v0.1.4
 * (c) 2018 iboying(weboying@gmail.com)
 * @license MIT
 */
"use strict";var callbackCenter={callback:void 0,urlReturnCallback:void 0,urlReturnChannels:["alipay_pc_direct"],success:function(){this.callback("success"),this.callback=void 0},cancel:function(e){var a=e||this.error("Canceled","支付取消");this.callback("cancel",a),this.callback=void 0},fail:function(e){var a=e||this.error("failed","支付失败");this.callback("fail",a),this.callback=void 0},error:function(e,a){return{msg:e||"",extra:a||""}},triggerUrlReturnCallback:function(e,a){"function"==typeof this.urlReturnCallback&&this.urlReturnCallback(e,a)},shouldReturnUrlByCallback:function(e){return"function"==typeof this.urlReturnCallback&&-1!==this.urlReturnChannels.indexOf(e)}},hasOwn={}.hasOwnProperty,utils={redirectTo:function(e,a){if(callbackCenter.shouldReturnUrlByCallback(a))callbackCenter.triggerUrlReturnCallback(null,e);else{if("undefined"==typeof window)throw new Error("\n Not a browser, redirect url: "+e+" \n");window.location.href=e}},queryStringify:function(n,e,t){var l=this;return void 0===n&&(n={}),"object"==typeof n?Object.keys(n).map(function(e){if("channel_url"===e)return null;if(!hasOwn.call(n,e)||"function"==typeof n[e])return null;var a="string"==typeof e?e:"",r=t?t+"["+a+"]":""+a;return"object"==typeof n[e]?l.queryString(n[e],null,r):encodeURIComponent(r)+"="+encodeURIComponent(n[e])}).filter(function(e){return!!e}).join("&"):n.toString?n.toString():""+n}},hasOwn$1={}.hasOwnProperty,ALIPAY_PC_DIRECT_URL="https://mapi.alipay.com/gateway.do",alipay_pc_direct={handleCharge:function(e){var a=channel.credential[e.channel],r=ALIPAY_PC_DIRECT_URL;hasOwn$1.call(a,"channel_url")&&(r=a.channel_url),hasOwn$1.call(a,"_input_charset")||hasOwn$1.call(a,"service")&&"create_direct_pay_by_user"===a.service&&(a._input_charset="utf-8");var n=utils.queryStringify(a,e.channel);utils.redirectTo(r+"?"+n,channel)}},hasOwn$2={}.hasOwnProperty,alipay_qr={handleCharge:function(){var e=charge.credential[charge.channel];hasOwn$2.call(e,"transaction_no")?this.tradePay(e.transaction_no):callbackCenter.fail(callbackCenter.error("invalid_credential","missing_field_transaction_no"))},tradePay:function(e){this.ready(function(){AlipayJSBridge.call("tradePay",{tradeNO:e},function(e){"9000"===e.resultCode?callbackCenter.success():"6001"===e.resultCode?callbackCenter.cancel(callbackCenter.error("Canceled",e.result)):callbackCenter.fail(callbackCenter.error("Failed",e.result))})})},ready:function(e){void 0===e&&(e=function(){}),window.AlipayJSBridge?e():document.addEventListener("AlipayJSBridgeReady",e,!1)}},hasOwn$3={}.hasOwnProperty,ALIPAY_WAP_URL="https://mapi.alipay.com/gateway.do",alipay_wap={handleCharge:function(e){var a=e.credential;"string"==typeof a?utils.redirectTo(a):"object"==typeof a?(hasOwn$3.call(a,"_input_charset")||(hasOwn$3.call(a,"service")&&"alipay.wap.create.direct.pay.by.user"===a.service||hasOwn$3.call(a,"req_data"))&&(a._input_charset="utf-8"),utils.redirectTo(ALIPAY_WAP_URL+"?"+utils.queryStringify(a))):callbackCenter.fail(callbackCenter.error("invalid_credential","credential 格式不正确"))}},store={},hasOwn$4={}.hasOwnProperty,wx_pub={handleCharge:function(e){var r=e.credential,a=["appId","timeStamp","nonceStr","package","signType","paySign"].reduce(function(e,a){return hasOwn$4.call(r,a)?e:e.concat(a)},[]);0<a.length?callbackCenter.fail(callbackCenter.error("invalid_credential","Missing field： "+a.join("、"))):(store.credential=r,this.prePayLogic())},prePayLogic:function(){if("undefined"==typeof WeixinJSBridge){var e=this.beginPay.bind(this);document.addEventListener?document.addEventListener("WeixinJSBridgeReady",e,!1):document.attachEvent&&(document.attachEvent("WeixinJSBridgeReady",e),document.attachEvent("onWeixinJSBridgeReady",e))}else this.beginPay()},beginPay:function(){hasOwn$4.call(store,"credential")&&WeixinJSBridge.invoke("getBrandWCPayRequest",store.credential,function(e){delete store.credential,"get_brand_wcpay_request:ok"===e.err_msg?callbackCenter.success():"get_brand_wcpay_request:cancel"===e.err_msg?callbackCenter.cancel():callbackCenter.fail(callbackCenter.error("wx_result_fail",e.err_msg))})}},hasOwn$5={}.hasOwnProperty,wx_wap={handleCharge:function(e){var a=e.credential;"string"==typeof a?utils.redirectTo(a):"object"==typeof a&&hasOwn$5.call(a,"mweb_url")?utils.redirectTo(a.mweb_url+"?"+utils.queryStringify(a,{encode:!0})):callbackCenter.fail(callbackCenter.error("invalid_credential","credential 格式不正确"))}},hasOwn$6={}.hasOwnProperty,isWxProgramClient="undefined"!=typeof wx&&wx.requestPayment,wx_lite={handleCharge:function(e){var r=e.credential,a=["appId","timeStamp","nonceStr","package","signType","paySign"].reduce(function(e,a){return hasOwn$6.call(r,a)?e:e.concat(a)},[]);0<a.length?callbackCenter.fail(callbackCenter.error("invalid_credential","Missing field： "+a.join("、"))):(store.wx_lite_credential=r,this.beginPay(r))},beginPay:function(){if(isWxProgramClient){var e=store.wx_lite_credential;delete e.appId,e.complete=function(e){"requestPayment:ok"===e.errMsg&&callbackCenter.success(),"requestPayment:fail cancel"===e.errMsg&&callbackCenter.cancel(),e.err_code&&e.err_desc&&callbackCenter.fail(callbackCenter.error(e.err_desc,e))},wx.requestPayment(e)}else callbackCenter.fail(callbackCenter.error("invalid_client","请在微信小程序中打开"))}},channels={wx_lite:wx_lite,alipay_pc_direct:alipay_pc_direct,alipay_qr:alipay_qr,alipay_wap:alipay_wap,wx_pub:wx_pub,wx_wap:wx_wap},PayStar=function(){this.charge={}};PayStar.prototype.setUrlReturnCallback=function(e,a){if("function"!=typeof e)throw new Error("callback need to be a function");if(callbackCenter.urlReturnCallback=e,void 0!==channels){if(!Array.isArray(channels))throw new Error("channels need to be an array");callbackCenter.urlReturnChannels=a}return this},PayStar.prototype.pay=function(e,a){var r=(this.charge=e).channel;a?"function"==typeof a?(callbackCenter.callback=a,r?channels[r]?channels[r].handleCharge(e):callbackCenter.fail(callbackCenter.error("Channel Error: ","The channel '"+r+"' is not support.")):callbackCenter.fail(callbackCenter.error("Charge Error: ","There is no channel in charge object."))):console.error("Callback must be a function."):console.error('You should set a callback with "pay" method to process paying result.')};var index=new PayStar;module.exports=index;